@model Web.Models.RegisterClientViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crear cuenta - MechaGestionEX</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/css/login.css" asp-append-version="true" />
</head>
<body>
    <main class="form-register">
        <div class="card rounded-4 shadow">
            <div class="card-body p-4 p-md-5">
                <div class="text-center pb-3 border-bottom">
                    <h1 class="fw-bold fs-3 mb-1">Crear cuenta</h1>
                    <p class="text-secondary mb-0">Completa tus datos para registrarte</p>
                </div>

                <form asp-controller="Account" asp-action="RegisterClient" method="post" class="pt-3" id="formRegistroCliente">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="row g-3">
                        <div class="col-12">
                            <h5 class="mb-2">Datos de la cuenta</h5>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="NombreUsuario" class="form-control" placeholder="usuario" />
                                <label asp-for="NombreUsuario"></label>
                            </div>
                            <span asp-validation-for="NombreUsuario" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="Correo" class="form-control" placeholder="correo@ejemplo.com" />
                                <label asp-for="Correo"></label>
                            </div>
                            <span asp-validation-for="Correo" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="Password" class="form-control" placeholder="Contraseña" />
                                <label asp-for="Password"></label>
                            </div>
                            <span asp-validation-for="Password" class="text-danger small"></span>
                            <small id="passwordHelp" class="small text-muted">
                                La contraseña debe tener al menos 8 caracteres, incluyendo mayúsculas, minúsculas, números y un símbolo.
                            </small>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="ConfirmPassword" class="form-control" placeholder="Confirmar contraseña" />
                                <label asp-for="ConfirmPassword"></label>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                        </div>

                        <div class="col-12">
                            <h5 class="mt-3 mb-2">Datos del cliente</h5>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating position-relative">
                                <input asp-for="Rut" class="form-control" placeholder="12.345.678-9" id="Rut" autocomplete="off" />
                                <label asp-for="Rut"></label>
                            </div>
                            <span asp-validation-for="Rut" class="text-danger small" id="rutValidationSpan"></span>
                            <div class="small mt-1" id="rutEstado" aria-live="polite"></div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="Nombre" class="form-control" placeholder="Nombre y Apellido" />
                                <label asp-for="Nombre"></label>
                            </div>
                            <span asp-validation-for="Nombre" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="Telefono" class="form-control" placeholder="Teléfono" />
                                <label asp-for="Telefono"></label>
                            </div>
                            <span asp-validation-for="Telefono" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-floating">
                                <input asp-for="Direccion" class="form-control" placeholder="Dirección" />
                                <label asp-for="Direccion"></label>
                            </div>
                            <span asp-validation-for="Direccion" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="regionSelect" class="form-label">Región</label>
                            <select id="regionSelect" class="form-select" name="RegionId">
                                <option value="">Seleccione una región</option>
                                @if (ViewBag.Regions != null)
                                {
                                    foreach (var r in ViewBag.Regions)
                                    {
                                        <option value="@r.id">@r.nombre</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label asp-for="ComunaId" class="form-label">Comuna</label>
                            <select asp-for="ComunaId" id="comunaSelect" class="form-select" disabled>
                                <option value="">Seleccione una comuna</option>
                            </select>
                            <span asp-validation-for="ComunaId" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="d-grid d-md-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg rounded-3" id="btnSubmit">
                            Crear cuenta
                        </button>
                        <a asp-controller="Account" asp-action="Login" class="btn btn-outline-secondary btn-lg rounded-3">
                            Volver al inicio de sesión
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const regionSelect = document.getElementById('regionSelect');
            const comunaSelect = document.getElementById('comunaSelect');
            const rutInput = document.getElementById('Rut');
            const rutEstado = document.getElementById('rutEstado');
            const rutSpan = document.getElementById('rutValidationSpan');
            const submitBtn = document.getElementById('btnSubmit');
            let debounceTimer = null;
            let lastQuery = '';
            let abortController = null;

            const form = document.getElementById('formRegistroCliente');
            const passwordInput = document.getElementById('Password');
            const confirmInput = document.getElementById('ConfirmPassword');
            const passwordHelp = document.getElementById('passwordHelp');

            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;


            function marcarInput(input, ok) {
            input.classList.remove('is-valid', 'is-invalid');
            if (ok === true) {
                input.classList.add('is-valid');
            } else if (ok === false) {
                input.classList.add('is-invalid');
            }
        }

        function validarPassword() {
            const value = passwordInput.value || "";

            if (!value) {
                marcarInput(passwordInput, null);
                if (passwordHelp) {
                    passwordHelp.classList.remove('text-danger');
                    passwordHelp.classList.add('text-muted');
                    passwordHelp.textContent = "La contraseña debe tener al menos 8 caracteres, incluyendo mayúsculas, minúsculas, números y un símbolo.";
                }
                return false;
            }

            const ok = passwordRegex.test(value);
            marcarInput(passwordInput, ok);

            if (passwordHelp) {
                if (ok) {
                    passwordHelp.classList.remove('text-danger');
                    passwordHelp.classList.add('text-muted');
                    passwordHelp.textContent = "Contraseña segura.";
                } else {
                    passwordHelp.classList.remove('text-muted');
                    passwordHelp.classList.add('text-danger');
                    passwordHelp.textContent = "La contraseña no cumple los requisitos de seguridad.";
                }
            }

            return ok;
        }

        function validarConfirmPassword() {
            const value = confirmInput.value || "";
            const passValue = passwordInput.value || "";

            if (!value) {
                marcarInput(confirmInput, null);
                return false;
            }

            const ok = value === passValue;
            marcarInput(confirmInput, ok);
            return ok;
        }

        if (passwordInput && confirmInput) {
            passwordInput.addEventListener('input', () => {
                validarPassword();
                validarConfirmPassword(); // Por si ya escribió la confirmación
            });

            confirmInput.addEventListener('input', () => {
                validarConfirmPassword();
            });

            form.addEventListener('submit', (e) => {
                const passOk = validarPassword();
                const confirmOk = validarConfirmPassword();

                // Si algo no cumple, cancelamos el submit
                if (!passOk || !confirmOk) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }




            regionSelect.addEventListener('change', async function () {
                const regionId = this.value;
                comunaSelect.innerHTML = '<option value="">Seleccione una comuna</option>';
                comunaSelect.disabled = true;
                if (!regionId) return;
                try {
        const resp = await fetch(`/Account/ComunasPorRegion?regionId=${encodeURIComponent(regionId)}`);
                                    if (!resp.ok) throw new Error('Error al cargar comunas');
                    const data = await resp.json();
                    for (const c of data) {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.nombre;
                        comunaSelect.appendChild(opt);
                    }
                    comunaSelect.disabled = data.length === 0;
                } catch (err) {
                    console.error(err);
                    comunaSelect.disabled = true;
                }
            });

            function limpiarRut(v) {
                return v.replace(/[^0-9kK]/g, '').toUpperCase();
            }
            function formatearRut(v) {
                if (v.length < 2) return v;
                const dv = v.slice(-1);
                let cuerpo = v.slice(0, -1);
                let salida = '';
                while (cuerpo.length > 3) {
                    salida = '.' + cuerpo.slice(-3) + salida;
                    cuerpo = cuerpo.slice(0, -3);
                }
                salida = cuerpo + salida;
                return salida + '-' + dv;
            }
            function calcularDv(cuerpo) {
                let suma = 0;
                let mult = 2;
                for (let i = cuerpo.length - 1; i >= 0; i--) {
                    suma += parseInt(cuerpo[i]) * mult;
                    mult = mult === 7 ? 2 : mult + 1;
                }
                const resto = 11 - (suma % 11);
                if (resto === 11) return '0';
                if (resto === 10) return 'K';
                return resto.toString();
            }
            function validarLocal(rutFormateado) {
                const regex = /^\d{1,2}\.\d{3}\.\d{3}-[\dkK]$/;
                if (!regex.test(rutFormateado)) return { formatoOk: false, dvOk: false };
                const limpio = rutFormateado.replace(/\./g, '').toUpperCase();
                const [cuerpo, dv] = limpio.split('-');
                const dvCalc = calcularDv(cuerpo);
                return { formatoOk: true, dvOk: dv === dvCalc };
            }
            function setEstado(clase, mensaje) {
                rutEstado.className = 'small ' + (clase ? clase : '');
                rutEstado.textContent = mensaje;
            }
            function marcarValidez(ok) {
                rutInput.classList.remove('is-valid', 'is-invalid');
                rutInput.classList.add(ok ? 'is-valid' : 'is-invalid');
            }

            async function consultarServidor(rutFormateado) {
                if (abortController) abortController.abort();
                abortController = new AbortController();
                try {
                    const url = `/Account/ValidarRutCliente?rut=${encodeURIComponent(rutFormateado)}`;
                    const resp = await fetch(url, { signal: abortController.signal });
                    if (!resp.ok) throw new Error('Error consulta servidor');
                    return await resp.json();
                } catch (e) {
                    if (e.name === 'AbortError') return null;
                    console.error(e);
                    return { validFormato: false, dvCorrecto: false, disponible: false, mensaje: 'Error de red.' };
                }
            }

            rutInput.addEventListener('input', () => {
                const limpio = limpiarRut(rutInput.value);
                const formateado = formatearRut(limpio);
                rutInput.value = formateado;

                const local = validarLocal(formateado);

                // Reset mensajes
                rutSpan.textContent = '';
                submitBtn.disabled = true;

                if (!local.formatoOk) {
                    marcarValidez(false);
                    setEstado('text-danger', 'Formato inválido.');
                    return;
                }
                if (!local.dvOk) {
                    marcarValidez(false);
                    setEstado('text-danger', 'Dígito verificador incorrecto.');
                    return;
                }

                // Localmente válido -> mostrar chequeo de disponibilidad
                setEstado('text-secondary', 'Verificando disponibilidad...');
                marcarValidez(true);

                if (formateado === lastQuery) {
                    return;
                }
                lastQuery = formateado;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const resultado = await consultarServidor(formateado);
                    if (!resultado) return; // abortado
                    if (!resultado.validFormato) {
                        marcarValidez(false);
                        setEstado('text-danger', resultado.mensaje || 'Formato inválido.');
                        submitBtn.disabled = true;
                        return;
                    }
                    if (!resultado.dvCorrecto) {
                        marcarValidez(false);
                        setEstado('text-danger', resultado.mensaje || 'Dígito verificador incorrecto.');
                        submitBtn.disabled = true;
                        return;
                    }
                    if (!resultado.disponible) {
                        marcarValidez(false);
                        setEstado('text-warning', 'RUT ya registrado.');
                        submitBtn.disabled = true;
                        return;
                    }
                    marcarValidez(true);
                    setEstado('text-success', 'RUT disponible.');
                    submitBtn.disabled = false;
                }, 400);
            });
        });
    </script>
</body>
</html>
